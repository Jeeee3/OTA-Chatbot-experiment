<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>H-Stay Mock</title>
  <link rel="stylesheet" href="./assets/style.css"/>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1 id="brand"></h1>
        <div class="meta" id="subtitle"></div>
      </div>
    </div>
    <div class="row">
      <div class="pill" id="pidpill"></div>
      <select id="langSel" class="input" style="width:auto; min-width:120px"></select>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="hd"><h2 id="taskTitle"></h2><span class="pill" id="condpill"></span></div>
      <div class="bd">
        <div class="small" id="taskText"></div>
        <div class="hr"></div>
        <div class="small" style="margin-bottom:8px"><b id="controlsTitle"></b></div>
        <div class="small" id="controlText"></div>
        <div class="hr"></div>

        <!-- left panel varies by condition -->
        <div id="leftPanel"></div>

        <div class="hr"></div>
        <div class="tiny" id="note"></div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <h2 id="listTitle">Hotels</h2>
        <div class="row">
          <button class="btn secondary" id="btnCompare" disabled></button>
          <button class="btn" id="btnContinue" disabled></button>
        </div>
      </div>
      <div class="bd">
        <div class="list" id="hotelList"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="modal">
  <div class="panel">
    <div class="hd">
      <div style="display:flex; align-items:center; gap:10px">
        <div class="logo" style="width:26px;height:26px;border-radius:10px"></div>
        <div>
          <div style="font-weight:800" id="modalTitle"></div>
          <div class="tiny" id="modalSub"></div>
        </div>
      </div>
      <button class="btn ghost" id="modalClose"></button>
    </div>
    <div class="bd" id="modalBody"></div>
  </div>
</div>

<script src="./assets/common.js"></script>
<script>
(function(){
  const condition = 'c2';
  const logger = makeLogger(condition);
  let hotels = [];
  let filtered = [];
  let selectedHotelId = null;
  let compareIds = new Set();

  function setLang(lang){
    const sel = document.getElementById('langSel');
    sel.value = lang;
    renderStatic();
    renderLeftPanel();
    renderHotels();
  }

  function renderStatic(){
    const lang = logger.lang;
    document.getElementById('brand').textContent = t(lang,'brand');
    document.getElementById('subtitle').textContent = t(lang,'subtitle');
    document.getElementById('pidpill').textContent = `PID: ${logger.pid}`;
    document.getElementById('condpill').textContent = condition.toUpperCase();
    document.getElementById('taskTitle').textContent = t(lang,'taskTitle');
    document.getElementById('taskText').textContent = t(lang,'taskText');
    document.getElementById('controlsTitle').textContent = t(lang,'controlsTitle');
    document.getElementById('controlText').textContent = t(lang,'controlText');
    document.getElementById('btnCompare').textContent = t(lang,'compare');
    document.getElementById('btnContinue').textContent = t(lang,'continue');
    const slt = document.getElementById('shortlistTitle'); if(slt) slt.textContent = t(lang,'shortlistTitle');
    document.getElementById('modalClose').textContent = t(lang,'close');
    document.getElementById('note').textContent = t(lang,'note');
  }

  function openModal(title, sub, html){
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalSub').textContent = sub || '';
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modal').classList.add('on');
  }
  function closeModal(){ document.getElementById('modal').classList.remove('on'); }
  document.getElementById('modalClose').onclick = closeModal;
  document.getElementById('modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') closeModal(); });

  function renderLeftPanel(){
    const lang = logger.lang;
    const host = document.getElementById('leftPanel');
    host.innerHTML = '';
    if(condition==='c3'){
      const box = document.createElement('div');
      box.innerHTML = `
        <div class="small" style="margin-bottom:8px"><b>${t(lang,'filtersTitle')}</b></div>
        <div class="row" style="align-items:flex-start">
          <div style="flex:1; min-width:220px">
            <label><input type="checkbox" id="fSust"/> ${t(lang,'sustainable')}<div class="tiny">${t(lang,'sustainableHint')}</div></label>
            <div class="hr"></div>
            <label>${t(lang,'priceRange')}</label>
            <input class="input" id="fPrice" type="range" min="500" max="900" step="10" value="900"/>
            <div class="tiny" id="fPriceVal"></div>
            <div class="hr"></div>
            <label>${t(lang,'ratingMin')}</label>
            <select id="fRating" class="input">
              <option value="0">0+</option>
              <option value="4.0">4.0+</option>
              <option value="4.3">4.3+</option>
              <option value="4.5">4.5+</option>
              <option value="4.7">4.7+</option>
            </select>
            <div class="hr"></div>
            <label>${t(lang,'metroMax')}</label>
            <select id="fMetro" class="input">
              <option value="999">Any</option>
              <option value="5">â‰¤ 5</option>
              <option value="8">â‰¤ 8</option>
              <option value="10">â‰¤ 10</option>
              <option value="12">â‰¤ 12</option>
            </select>
            <div class="hr"></div>
            <button class="btn secondary" id="btnReset">${t(lang,'reset')}</button>
          </div>
        </div>
      `;
      host.appendChild(box);

      const fSust = host.querySelector('#fSust');
      const fPrice = host.querySelector('#fPrice');
      const fPriceVal = host.querySelector('#fPriceVal');
      const fRating = host.querySelector('#fRating');
      const fMetro = host.querySelector('#fMetro');
      const btnReset = host.querySelector('#btnReset');
      function updatePriceVal(){ fPriceVal.textContent = `â‰¤ ${fmtPrice(parseInt(fPrice.value,10))}`; }
      updatePriceVal();

      function apply(){
        const maxP = parseInt(fPrice.value,10);
        const minR = parseFloat(fRating.value);
        const maxM = parseInt(fMetro.value,10);
        const mustS = fSust.checked;
        filtered = hotels.filter(h=>{
          if(h.price>maxP) return false;
          if(h.rating<minR) return false;
          if(h.metro_min>maxM) return false;
          if(mustS && !h.sustainable) return false;
          return true;
        });
        logger.push('filter_change', {mustS, maxP, minR, maxM, count: filtered.length});
        renderHotels();
      }

      fSust.onchange = apply;
      fPrice.oninput = ()=>{ updatePriceVal(); };
      fPrice.onchange = apply;
      fRating.onchange = apply;
      fMetro.onchange = apply;
      btnReset.onclick = ()=>{
        fSust.checked=false; fPrice.value=900; fRating.value="0"; fMetro.value="999";
        updatePriceVal();
        logger.push('filter_reset', {});
        apply();
      };
    }else{
      // chatbot panel
      const box = document.createElement('div');
      box.innerHTML = `
        <div class="small" style="margin-bottom:8px"><b>${t(lang,'chatTitle')}</b></div>
        <div class="card" style="background:transparent; box-shadow:none; border:1px solid var(--border); border-radius:18px">
          <div class="bd">
            <div class="chat" id="chat"></div>
            <div class="hr"></div>
            <div class="small" style="margin-bottom:6px"><b id="shortlistTitle"></b></div>
            <div class="shortlist" id="shortlist"></div>
            
            <div class="hr"></div>
            <div class="footer">
              <input class="input" id="chatInput" placeholder="${t(lang,'placeholder')}" />
              <button class="btn" id="chatSend">${t(lang,'send')}</button>
            </div>
            <div class="tiny" style="margin-top:8px">${t(lang,'controlText')}</div>
          </div>
        </div>
      `;
      host.appendChild(box);

      const chat = host.querySelector('#chat');
      const inp = host.querySelector('#chatInput');
      const send = host.querySelector('#chatSend');

      function addMsg(who, text){
        const wrap = document.createElement('div');
        wrap.className = 'msg ' + (who==='ai'?'ai':'me');
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.textContent = text;
        if(who==='ai'){
          wrap.appendChild(avatar);
          wrap.appendChild(bubble);
        }else{
          wrap.appendChild(bubble);
        }
        chat.appendChild(wrap);
        chat.scrollTop = chat.scrollHeight;
      }

      // scripted AI (upgraded: multi-turn, intent-based, stateful)
      const state = {
        // user preferences inferred from free text
        priority: null,   // 'price' | 'location' | 'comfort' | 'sustainability'
        budgetMax: null,
        wantsSustain: null, // true/false/null
        c1_choice: null, // 'A' | 'B' | 'C' (Template B)
        lastMentionedIds: [],
        turn: 0
      };

      const KW = {
        en: {
          greet: ['hi','hello','hey'],
          thanks: ['thanks','thank you','thx'],
          compare: ['compare','difference','vs','versus'],
          recommend: ['recommend','suggest','what should i','which should i','best option'],
          sustain: ['sustain','sustainable','eco','green','environment'],
          price: ['price','budget','cheap','expensive','cost'],
          location: ['location','metro','subway','distance','near','walk'],
          comfort: ['comfort','quiet','noise','room','bed','breakfast','gym','spacious'],
          detail: ['detail','more info','tell me more','policy','cancellation'],
          unsure: ['not sure','hard','difficult','confused','no idea']
        },
        zh: {
          greet: ['ä½ å¥½','å—¨','å“ˆå–½','åœ¨å—'],
          thanks: ['è°¢è°¢','æ„Ÿè°¢','å¤šè°¢'],
          compare: ['å¯¹æ¯”','æ¯”è¾ƒ','åŒºåˆ«','å·®å¼‚','å“ªä¸ªå¥½','å“ªä¸ªæ›´'],
          recommend: ['æ¨è','å»ºè®®','ä½ è§‰å¾—','ä½ ä¼šé€‰','æ€ä¹ˆé€‰','æœ€é€‚åˆ'],
          sustain: ['ç¯ä¿','å¯æŒç»­','ç»¿è‰²','ä½ç¢³','ç”Ÿæ€','ç¢³'],
          price: ['ä»·æ ¼','é¢„ç®—','ä¾¿å®œ','è´µ','èŠ±è´¹','æˆæœ¬','æ€§ä»·æ¯”'],
          location: ['ä½ç½®','åœ°é“','è·ç¦»','é™„è¿‘','èµ°è·¯','äº¤é€š','ä¾¿åˆ©','åˆ°'],
          comfort: ['èˆ’é€‚','å®‰é™','éš”éŸ³','æˆ¿é—´','åºŠ','æ—©é¤','å¥èº«æˆ¿','ç©ºé—´','å™ªéŸ³'],
          detail: ['è¯¦æƒ…','æ›´å¤šä¿¡æ¯','è¯´è¯´','æ”¿ç­–','å–æ¶ˆ','é€€è®¢'],
          unsure: ['ä¸ç¡®å®š','çº ç»“','ä¸çŸ¥é“','éš¾é€‰','å›°æƒ‘','çœ‹ä¸æ‡‚']
        }
      };

      function langKW(){ return (logger.lang==='zh') ? KW.zh : KW.en; }

      function extractIds(text){
        const up = (text || '').toUpperCase();
        const ids = [];
        ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O'].forEach(id=>{
          // match standalone or with punctuation
          const r = new RegExp(`\\b${id}\\b`);
          if(r.test(up) || up.includes(`${id}.`) || up.includes(`${id} `) || up.includes(` ${id}`)) ids.push(id);
        });
        // Also allow "é…’åº—A" / "Aé…’åº—"
        ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O'].forEach(id=>{
          if((text||'').includes(`é…’åº—${id}`) || (text||'').includes(`${id}é…’åº—`)) if(!ids.includes(id)) ids.push(id);
        });
        return ids;
      }

      function parseBudget(text){
        // supports "<=800", "800ä»¥å†…", "budget 800", "under 800"
        const s = text || '';
        let m = s.match(/(?:<=|â‰¤)\s*(\d{3,4})/);
        if(m) return parseInt(m[1],10);
        m = s.match(/(\d{3,4})\s*(?:ä»¥å†…|ä»¥ä¸‹)/);
        if(m) return parseInt(m[1],10);
        m = s.match(/(?:under|below|budget)\s*\$?\s*(\d{3,4})/i);
        if(m) return parseInt(m[1],10);
        m = s.match(/(\d{3,4})\s*(?:rmb|yuan|cny|å—|å…ƒ)/i);
        if(m) return parseInt(m[1],10);
        return null;
      }

      function detectIntent(text){
        const t0 = (text||'').toLowerCase();
        const k = langKW();
        const has = (arr)=>arr.some(w=> (logger.lang==='zh') ? (text||'').includes(w) : t0.includes(w));
        const ids = extractIds(text);
        const budget = parseBudget(text);
        const intent = {
          ids,
          budget,
          greet: has(k.greet),
          thanks: has(k.thanks),
          compare: has(k.compare),
          recommend: has(k.recommend),
          sustain: has(k.sustain),
          price: has(k.price),
          location: has(k.location),
          comfort: has(k.comfort),
          detail: has(k.detail),
          unsure: has(k.unsure)
        };
        // if they mention 2+ ids, treat as compare
        if(intent.ids.length>=2) intent.compare = true;
        return intent;
      }

      function scoreHotel(h){
        // Base weights
        let wPrice = 0.35, wLoc = 0.25, wComfort = 0.25, wSust = 0.15;
        if(state.priority==='price'){ wPrice=0.5; wLoc=0.2; wComfort=0.2; wSust=0.1; }
        if(state.priority==='location'){ wPrice=0.25; wLoc=0.45; wComfort=0.2; wSust=0.1; }
        if(state.priority==='comfort'){ wPrice=0.25; wLoc=0.2; wComfort=0.45; wSust=0.1; }
        if(state.priority==='sustainability'){ wPrice=0.25; wLoc=0.2; wComfort=0.2; wSust=0.35; }

        // Condition 1: incorporate Template B choice (soft, not coercive)
        if(condition==='c1'){
          if(state.c1_choice==='A'){ wPrice += 0.08; wSust -= 0.05; }
          if(state.c1_choice==='B'){ wComfort += 0.06; wSust += 0.04; }
          if(state.c1_choice==='C'){ wSust += 0.12; wPrice -= 0.05; }
        }

        // Budget softness: penalize above budget, not hard filter
        let budgetPenalty = 0;
        if(state.budgetMax && h.price>state.budgetMax){
          budgetPenalty = (h.price - state.budgetMax) / 400; // 0~1
        }

        // Normalize features
        const priceScore = 1 - (h.price - 500) / 450; // 500..950
        const locScore = 1 - Math.min(h.metro_min, 15) / 15;
        const comfortScore = Math.min(1, (h.rating - 4.0) / 0.9); // 4.0..4.9
        const sustScore = h.sustainable ? 1 : 0.1;

        let s = wPrice*priceScore + wLoc*locScore + wComfort*comfortScore + wSust*sustScore;
        s -= budgetPenalty * 0.25;
        return s;
      }

      function applyOrdering(){
        // sort hotels by score (chatbot conditions)
        hotels.sort((a,b)=>scoreHotel(b)-scoreHotel(a));
      }

      function pick(arr){
        return arr[Math.floor(Math.random()*arr.length)];
      }

      function hotelLine(h){
        const lang = logger.lang;
        const name = hotelTitle(h, lang);
        const sust = h.sustainable ? ` Â· ğŸŒ¿ ${sustLabel(h, lang)}` : '';
        return `${h.id}. ${name} â€” ${fmtPrice(h.price)} Â· â˜… ${h.rating.toFixed(1)} Â· ğŸš‡ ${h.metro_min} min${sust}`;
      }

      function compareText(ids){
        const lang = logger.lang;
        const hs = ids.map(id=>hotels.find(x=>x.id===id)).filter(Boolean);
        if(hs.length<2) return lang==='zh' ? 'ä½ æƒ³å¯¹æ¯”å“ªä¸¤å®¶ï¼Ÿä¾‹å¦‚ A å’Œ Cã€‚' : 'Which two hotels would you like to compare (e.g., A and C)?';
        const lines = hs.map(h=>`- ${hotelLine(h)}\n  ${(lang==='zh') ? 'äº®ç‚¹' : 'Highlights'}: ${highlights(h, lang).join(' Â· ')}`).join('\n');
        return (lang==='zh'
          ? `å½“ç„¶å¯ä»¥ã€‚è¿™é‡Œæ˜¯å¯¹æ¯”ï¼š\n${lines}\n\nä½ æ›´åœ¨æ„ï¼šä»·æ ¼ / ä½ç½® / èˆ’é€‚åº¦ / å¯æŒç»­ï¼Ÿæˆ‘å¯ä»¥æŒ‰ä½ çš„ä¾§é‡ç‚¹å†æ€»ç»“ä¸€éã€‚`
          : `Sure â€” hereâ€™s a quick comparison:\n${lines}\n\nWhich matters most to you right now: price, location, comfort, or sustainability? I can summarize accordingly.`
        );
      }

      function recommendText(){
        const lang = logger.lang;
        applyOrdering();
        const top = hotels.slice(0,3);
        const bullets = top.map(h=>`- ${hotelLine(h)}`).join('\n');
        const autonomy = (lang==='zh')
          ? 'æˆ‘ä¸ä¼šæ›¿ä½ ä¸‹å†³å®šï¼Œä½†æˆ‘å¯ä»¥æŠŠæƒè¡¡ç‚¹è®²æ¸…æ¥šï¼Œæœ€åç”±ä½ é€‰ã€‚'
          : "I wonâ€™t choose for you, but I can make the trade-offs clearer â€” you decide.";
        const follow = (lang==='zh')
          ? 'ä½ æƒ³æŠŠâ€œé¢„ç®—/ä½ç½®/èˆ’é€‚/å¯æŒç»­â€é‡Œå“ªä¸€é¡¹æ”¾ç¬¬ä¸€ä½ï¼Ÿï¼ˆå›å¤ï¼šä»·æ ¼/ä½ç½®/èˆ’é€‚/å¯æŒç»­ï¼‰'
          : 'Which should be your #1 priority for this trip? (Reply: price / location / comfort / sustainability)';
        return `${autonomy}\n\n${(lang==='zh'?'åŸºäºä½ ç›®å‰çš„ä¿¡æ¯ï¼Œæˆ‘ä¼šä¼˜å…ˆè®©ä½ çœ‹è¿™å‡ å®¶ï¼š':'Based on what youâ€™ve said so far, these are worth a look:')}\n${bullets}\n\n${follow}`;
      }

      function sustainExplainText(ids){
        const lang = logger.lang;
        if(ids.length===1){
          const h = hotels.find(x=>x.id===ids[0]);
          if(!h) return '';
          if(condition==='c2'){
            return lang==='zh'
              ? `å…³äº${h.id}ï¼Œé¡µé¢é‡Œå¯æŒç»­ä¿¡æ¯æœ‰é™ã€‚æˆ‘å¯ä»¥æŠŠè¯¦æƒ…é¡µä¸­å‡ºç°çš„å†…å®¹æ•´ç†ç»™ä½ ï¼ˆä½ ä¹Ÿå¯ä»¥ç‚¹å‡»â€œæŸ¥çœ‹è¯¦æƒ…â€ï¼‰ã€‚`
              : `For ${h.id}, sustainability info on the page is limited. I can summarize whatâ€™s shown in the details (or you can click â€œView detailsâ€).`;
          }
          // c1: educational but non-coercive
          const bl = sustBlurb(h, lang);
          return lang==='zh'
            ? `å…³äº${h.id}çš„å¯æŒç»­ä¿¡æ¯ï¼š${bl}\n\nå°±è¿™æ¬¡æ—…è¡Œè€Œè¨€ï¼Œä½ å¸Œæœ›å¯æŒç»­æ˜¯â€œåŠ åˆ†é¡¹â€è¿˜æ˜¯â€œå°½é‡è¦æœ‰â€ï¼Ÿ`
            : `Sustainability info for ${h.id}: ${bl}\n\nFor this trip, do you want sustainability as a bonus or as something youâ€™d prefer to have?`;
        }
        // general
        if(condition==='c2'){
          return lang==='zh'
            ? 'å¦‚æœä½ å…³å¿ƒç¯ä¿ï¼Œæˆ‘å¯ä»¥æŠŠæ¯å®¶é…’åº—é¡µé¢ä¸­å‡ºç°çš„ç›¸å…³æè¿°åŸæ ·æ•´ç†å‡ºæ¥ï¼ˆä¸åšè¯„ä»·ï¼‰ã€‚ä½ æƒ³çœ‹å“ªå‡ å®¶ï¼Ÿ'
            : 'If you care about sustainability, I can summarize what each hotel page shows (without judging). Which hotels should I pull up?';
        }
        return lang==='zh'
          ? 'å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥æŠŠå¯æŒç»­ä¿¡æ¯ä½œä¸ºå¯¹æ¯”ç»´åº¦ä¹‹ä¸€ï¼Œå¸®ä½ æŠŠâ€œèˆ’é€‚/ä»·æ ¼/ä½ç½®/ç¯ä¿â€ä¹‹é—´çš„æƒè¡¡ç‚¹è®²æ¸…æ¥šã€‚ä½ ç°åœ¨æ›´åå‘å“ªä¸€é¡¹ï¼Ÿ'
          : 'If youâ€™d like, I can include sustainability as one comparison dimension and clarify trade-offs between comfort, price, location, and sustainability. Which matters most to you right now?';
      }

      function inferPriority(intent, text){
        // explicit priority
        if(logger.lang==='zh'){
          if((text||'').includes('ä»·æ ¼') || (text||'').includes('é¢„ç®—') || (text||'').includes('æ€§ä»·æ¯”')) return 'price';
          if((text||'').includes('ä½ç½®') || (text||'').includes('åœ°é“') || (text||'').includes('äº¤é€š')) return 'location';
          if((text||'').includes('èˆ’é€‚') || (text||'').includes('å®‰é™') || (text||'').includes('éš”éŸ³')) return 'comfort';
          if((text||'').includes('å¯æŒç»­') || (text||'').includes('ç¯ä¿') || (text||'').includes('ç»¿è‰²')) return 'sustainability';
        }else{
          const s = (text||'').toLowerCase();
          if(s.includes('price') || s.includes('budget') || s.includes('cheap') || s.includes('value')) return 'price';
          if(s.includes('location') || s.includes('metro') || s.includes('subway') || s.includes('near')) return 'location';
          if(s.includes('comfort') || s.includes('quiet') || s.includes('room') || s.includes('bed')) return 'comfort';
          if(s.includes('sustain') || s.includes('eco') || s.includes('green')) return 'sustainability';
        }
        // implicit: if they asked about one dimension strongly
        if(intent.price && !intent.location && !intent.comfort && !intent.sustain) return 'price';
        if(intent.location && !intent.price && !intent.comfort && !intent.sustain) return 'location';
        if(intent.comfort && !intent.price && !intent.location && !intent.sustain) return 'comfort';
        if(intent.sustain && !intent.price && !intent.location && !intent.comfort) return 'sustainability';
        return null;
      }

      // Initial scripted opening (still realistic, but not dead-end)
      function ai(text){ addMsg('ai', text); logger.push('chat_ai', {text}); }
      function user(text){ addMsg('me', text); logger.push('chat_user', {text}); }

      if(condition==='c1'){
        ai(t(lang,'c1_open_1'));
        setTimeout(()=>ai(t(lang,'c1_q')), 250);
      }else{
        ai(t(lang,'c2_open_1'));
        setTimeout(()=>{
          const lang2 = logger.lang;
          ai(lang2==='zh'
            ? 'ä¾‹å¦‚ä½ å¯ä»¥é—®ï¼š\n- â€œé¢„ç®—800ä»¥å†…ï¼Œç¦»åœ°é“è¿‘â€\n- â€œå¯¹æ¯”Aå’ŒCçš„å·®å¼‚â€\n- â€œå“ªå®¶æ›´å®‰é™/æ›´é€‚åˆä¼‘æ¯â€\nä½ ä¹Ÿå¯ä»¥éšä¾¿ç”¨ä¸€å¥è¯æè¿°ä½ çš„éœ€æ±‚ï¼Œæˆ‘ä¼šè¿½é—®å…³é”®ç‚¹å¹¶å¸®ä½ ç¼©å°èŒƒå›´ã€‚'
            : 'For example, you can ask:\n- â€œBudget under 800 and close to the metroâ€\n- â€œCompare A vs Câ€\n- â€œWhich one is quieter?â€\nOr just describe your needs in one sentence â€” Iâ€™ll ask a couple of clarifying questions and narrow options with you.');
        }, 250);
      }

      function respond(userText){
        const lang2 = logger.lang;
        if(!userText.trim()) return;
        state.turn += 1;

        user(userText);
        const intent = detectIntent(userText);
        logger.push('chat_intent', intent);

        // ---- conversation memory ----
        state.lastQuestion = state.lastQuestion || null; // 'budget'|'metro'|'priority'|'compare'|'relax'
        state.metroMax = state.metroMax || null;
        state.wantQuiet = state.wantQuiet || false;

        // carryover: if last question expects a short numeric answer
        const raw = (userText||'').trim();
        const digits = raw.match(/(\d{1,2})/);
        const hasLe = raw.includes('â‰¤') || raw.includes('<=');
        if(state.lastQuestion==='metro' && !intent.location){
          if(digits){
            state.metroMax = parseInt(digits[1],10);
            logger.push('metro_set', {metroMax: state.metroMax, via:'carryover'});
          }
        }
        if(state.lastQuestion==='budget' && !intent.price){
          const d3 = raw.match(/(\d{3,4})/);
          if(d3){
            state.budgetMax = parseInt(d3[1],10);
            logger.push('budget_set', {budgetMax: state.budgetMax, via:'carryover'});
          }
        }
        if(state.lastQuestion==='priority'){
          // accept short labels
          if(lang2==='zh'){
            if(raw.includes('ä»·æ ¼')) state.priority='price';
            else if(raw.includes('ä½ç½®')||raw.includes('åœ°é“')||raw.includes('äº¤é€š')) state.priority='location';
            else if(raw.includes('èˆ’é€‚')||raw.includes('å®‰é™')) state.priority='comfort';
            else if(raw.includes('å¯æŒç»­')||raw.includes('ç¯ä¿')||raw.includes('ç»¿è‰²')) state.priority='sustainability';
          }else{
            const low = raw.toLowerCase();
            if(low.includes('price')) state.priority='price';
            else if(low.includes('location')||low.includes('metro')) state.priority='location';
            else if(low.includes('comfort')||low.includes('quiet')) state.priority='comfort';
            else if(low.includes('sustain')) state.priority='sustainability';
          }
          if(state.priority){
            logger.push('priority_set', {priority: state.priority, via:'carryover'});
          }
        }

        // track hotel mentions
        if(intent.ids.length){
          state.lastMentionedIds = intent.ids.slice(0,6);
        }

        // Template B capture in c1 (A/B/C)
        if(condition==='c1' && !state.c1_choice){
          const up = raw.toUpperCase();
          if(up==='A'||up==='B'||up==='C'){
            state.c1_choice = up;
            logger.push('c1_choice', {choice: up});
            const reflect = (up==='A')
              ? (lang2==='zh' ? 'æ˜ç™½ï¼šè¿™æ¬¡æ›´åå‘æ€§ä»·æ¯”ä¸ä¾¿åˆ©ï¼Œç¯ä¿ä½œä¸ºåŠ åˆ†é¡¹ã€‚' : 'Got it â€” value and convenience first; sustainability as a bonus.')
              : (up==='B')
                ? (lang2==='zh' ? 'æ˜ç™½ï¼šèˆ’é€‚é‡è¦ï¼ŒåŒæ—¶å°½é‡é¿å¼€æ˜æ˜¾ä¸ç¯ä¿çš„é€‰é¡¹ã€‚' : 'Got it â€” comfort matters, and youâ€™d like to avoid clearly unsustainable options.')
                : (lang2==='zh' ? 'æ˜ç™½ï¼šè¿™æ¬¡ä½ æ›´é‡è§†å¯æŒç»­æ€§ï¼Œæ„¿æ„åœ¨ä»·æ ¼æˆ–ä½ç½®ä¸Šåšäº›å–èˆã€‚' : 'Got it â€” sustainability matters more this time, and youâ€™re open to small trade-offs on price or location.');
            ai(reflect + (lang2==='zh' ? ' ä½ å¯ä»¥ç›´æ¥å‘Šè¯‰æˆ‘é¢„ç®—ä¸Šé™ï¼ˆå¦‚600ä»¥å†…ï¼‰æˆ–æƒ³å¯¹æ¯”å“ªä¸¤å®¶ï¼ˆå¦‚Aå’ŒGï¼‰ã€‚' : ' Tell me your budget (e.g., under 600) or two hotels to compare (e.g., A and G).'));
            state.lastQuestion = null;
            applyOrdering(); renderHotels(); updateShortlist([]);
            return;
          }
        }

        // budget parse
        if(intent.budget){
          state.budgetMax = intent.budget;
          const rg = raw.match(/(\d{3,4})\s*[\-~â€”åˆ°è‡³]\s*(\d{3,4})/);
          if(rg){ state.budgetMax = Math.max(parseInt(rg[1]), parseInt(rg[2])); }
          const in1 = raw.match(/(\d{3,4})\s*(ä»¥å†…|ä»¥ä¸‹|under|below)/i);
          if(in1){ state.budgetMax = parseInt(in1[1]); }
          logger.push('budget_set', {budgetMax: state.budgetMax});
        }

        // infer priority
        const pr = inferPriority(intent, userText);
        if(pr){
          state.priority = pr;
          logger.push('priority_set', {priority: pr, via:'message'});
        }

        // quiet preference
        if(lang2==='zh'){
          if(raw.includes('å®‰é™') || raw.includes('éš”éŸ³') || raw.includes('å™ªéŸ³')) state.wantQuiet = true;
        }else{
          const low = raw.toLowerCase();
          if(low.includes('quiet') || low.includes('noise') || low.includes('soundproof')) state.wantQuiet = true;
        }

        // metro parse robust
        const metroZh = raw.match(/(åœ°é“|åˆ°åœ°é“|ç¦»åœ°é“).{0,6}(<=|â‰¤|ä¸è¶…è¿‡|æœ€å¤š)?\s*(\d{1,2})\s*åˆ†é’Ÿ/);
        const metroEn = raw.match(/(metro|subway).{0,10}(<=|â‰¤|under|within|no more than)?\s*(\d{1,2})\s*(min|minutes)/i);
        if(metroZh) state.metroMax = parseInt(metroZh[3],10);
        if(metroEn) state.metroMax = parseInt(metroEn[3],10);
        if(state.metroMax && (metroZh||metroEn)){
          logger.push('metro_set', {metroMax: state.metroMax, via:'pattern'});
        }

        // ---- helper funcs ----
        function isQuietHotel(h){
          const zh = (h.highlights_zh||[]).join(' ');
          const en = (h.highlights_en||[]).join(' ').toLowerCase();
          return zh.includes('å®‰é™') || zh.includes('éš”éŸ³') || en.includes('quiet') || en.includes('soundproof');
        }

        function hardOk(h){
          if(state.budgetMax && h.price > state.budgetMax) return false;
          if(state.metroMax && h.metro_min > state.metroMax) return false;
          if(state.wantQuiet && !isQuietHotel(h)) return false;
          if(state.wantsSustain===true && !h.sustainable) return false;
          return true;
        }

        function candidates(){
          const cand = hotels.filter(hardOk);
          return cand;
        }

        function bestN(arr, n){
          const a = arr.slice().sort((x,y)=>scoreHotel(y)-scoreHotel(x));
          return a.slice(0,n);
        }

        function briefList(arr){
          const lang3 = logger.lang;
          return arr.map(h=>{
            const nm = hotelTitle(h, lang3);
            return `${h.id}. ${nm}`;
          }).join(lang3==='zh'?'ã€':', ');
        }

        function constraintSummary(){
          const pieces = [];
          if(state.budgetMax) pieces.push(lang2==='zh' ? `é¢„ç®—â‰¤Â¥${state.budgetMax}` : `budget â‰¤ Â¥${state.budgetMax}`);
          if(state.metroMax) pieces.push(lang2==='zh' ? `åœ°é“â‰¤${state.metroMax}åˆ†é’Ÿ` : `metro â‰¤ ${state.metroMax} min`);
          if(state.wantQuiet) pieces.push(lang2==='zh' ? 'åå®‰é™' : 'quiet');
          if(state.priority){
            const map = {price:(lang2==='zh'?'ä»·æ ¼ä¼˜å…ˆ':'price-first'),
                         location:(lang2==='zh'?'ä½ç½®ä¼˜å…ˆ':'location-first'),
                         comfort:(lang2==='zh'?'èˆ’é€‚ä¼˜å…ˆ':'comfort-first'),
                         sustainability:(lang2==='zh'?'å¯æŒç»­ä¼˜å…ˆ':'sustainability-first')};
            pieces.push(map[state.priority]||state.priority);
          }
          return pieces.length ? pieces.join('ï½œ') : (lang2==='zh'?'ï¼ˆæœªè®¾ç½®åå¥½ï¼‰':'(no preferences yet)');
        }

        // ---- UI: shortlist rendering ----
        function whyTag(h){
          const tags = [];
          if(state.budgetMax && h.price<=state.budgetMax) tags.push(lang2==='zh'?'ç¬¦åˆé¢„ç®—':'within budget');
          if(state.metroMax && h.metro_min<=state.metroMax) tags.push(lang2==='zh'?'è¿‘åœ°é“':'close to metro');
          if(state.wantQuiet && isQuietHotel(h)) tags.push(lang2==='zh'?'æ›´å®‰é™':'quieter');
          if(h.sustainable && condition==='c1') tags.push(lang2==='zh'?'å¯æŒç»­ä¿¡æ¯æ›´æ¸…æ™°':'clearer sustainability info');
          if(tags.length===0){
            tags.push(lang2==='zh'?'è¾ƒåŒ¹é…ä½ çš„åå¥½':'matches your preferences');
          }
          return tags.slice(0,2).join(lang2==='zh'?' + ':' + ');
        }

        window.updateShortlist = function(arr){
          window._lastShortlist = arr;
          const box = document.getElementById('shortlist');
          if(!box) return;
          box.innerHTML = '';
          arr.forEach(h=>{
            const card = document.createElement('div');
            card.className = 'scard';
            const title = `${t(lang2,'aiPicked')} Â· ${h.id}. ${hotelTitle(h, lang2)}`;
            const why = whyTag(h);
            card.innerHTML = `
              <div class="top">
                <div>
                  <div class="ttl">${title}</div>
                  <div class="why">${why}</div>
                </div>
              </div>
              <div class="actions">
                <button class="sbtn" data-act="view" data-id="${h.id}">${t(lang2,'view')}</button>
                <button class="sbtn" data-act="cmp" data-id="${h.id}">${t(lang2,'addToCompare')}</button>
                <button class="sbtn primary" data-act="sel" data-id="${h.id}">${t(lang2,'select')}</button>
              </div>`;
            box.appendChild(card);
          });

          box.querySelectorAll('button[data-act="view"]').forEach(btn=>{
            btn.onclick = ()=>{
              const id = btn.getAttribute('data-id');
              const h = hotels.find(x=>x.id===id);
              logger.push('view_details', {hotelId:id, via:'shortlist'});
              const sustSection = `
                <div class="hr"></div>
                <div style="font-weight:800; margin-bottom:6px">${t(lang2,'sustainability')}</div>
                <div class="small">${(condition==='c3') ? t(lang2,'sustainabilityText') : sustBlurb(h, lang2)}</div>
              `;
              openModal(
                `${h.id}. ${hotelTitle(h, lang2)}`,
                `â˜… ${h.rating.toFixed(1)} Â· ${fmtPrice(h.price)} Â· ğŸš‡ ${h.metro_min} min`,
                `<div class="small"><b>${lang2==='zh'?'äº®ç‚¹':'Highlights'}</b>: ${highlights(h, lang2).join(' Â· ')}</div>
                 <div class="small" style="margin-top:8px"><b>${lang2==='zh'?'å–æ¶ˆæ”¿ç­–':'Cancellation'}</b>: ${cancelText(h, lang2)}</div>
                 ${sustSection}`
              );
            };
          });
          box.querySelectorAll('button[data-act="sel"]').forEach(btn=>{
            btn.onclick = ()=>{
              const id = btn.getAttribute('data-id');
              selectedHotelId = id;
              logger.push('select_hotel', {hotelId:id, via:'shortlist'});
                            document.getElementById('btnCompare').disabled = (compareIds.size<2);
              const bsl2 = document.getElementById('btnCompareSL'); if(bsl2) bsl2.disabled = (compareIds.size<2);
              btn.textContent = t(lang2,'removeFromCompare');
              btn.classList.add('secondary');
              btn.onclick = ()=>{
                compareIds.delete(id);
                logger.push('compare_toggle', {hotelId:id, checked:false, via:'shortlist', size: compareIds.size});
                document.getElementById('btnCompare').disabled = (compareIds.size<2);
              const bsl2 = document.getElementById('btnCompareSL'); if(bsl2) bsl2.disabled = (compareIds.size<2);
                updateShortlist(arr);
              };
            };
          });
        }

        // ---- routing: if user asks compare/details/recommend, handle explicitly ----
        if(intent.compare){
          const ids = intent.ids.length ? intent.ids : (state.lastMentionedIds||[]);
          ai(compareText(ids));
          state.lastQuestion = 'compare';
          return;
        }

        if(intent.detail && intent.ids.length===1){
          const id = intent.ids[0];
          const h = hotels.find(x=>x.id===id);
          if(h){
            ai((lang2==='zh'
              ? `å¥½çš„ã€‚${h.id} çš„å…³é”®ä¿¡æ¯æˆ‘å…ˆç®€å•è¯´ä¸€å¥ï¼š${fmtPrice(h.price)}ï¼Œåˆ°åœ°é“${h.metro_min}åˆ†é’Ÿï¼Œè¯„åˆ†${h.rating.toFixed(1)}ã€‚éœ€è¦æˆ‘å±•å¼€å¯¹æ¯”ï¼ˆæ¯”å¦‚å’Œå¦ä¸€å®¶ï¼‰è¿˜æ˜¯ä½ å…ˆç‚¹â€œæŸ¥çœ‹è¯¦æƒ…â€ï¼Ÿ`
              : `Sure. Quick summary for ${h.id}: ${fmtPrice(h.price)}, ${h.metro_min} min to metro, rating ${h.rating.toFixed(1)}. Do you want a comparison with another hotel, or would you click â€œView detailsâ€ first?`));
            state.lastQuestion = null;
            // shortlist focus that single hotel
            updateShortlist([h]);
            return;
          }
        }

        // ---- main narrowing ----
        let cand = candidates();
        state.prevShortlistIds = state.prevShortlistIds || [];
        const used = constraintSummary();

        // Decide shortlist size (1-2 if small)
        let pickN = 3;
        if(cand.length<=2) pickN = cand.length;
        if(cand.length==0){
          // near-miss: show best 2-3 and ask which constraint to relax
          const near = bestN(hotels, 3);
          updateShortlist(near);
          ai((lang2==='zh'
            ? `æˆ‘å·²ç»åº”ç”¨äº†ï¼š${used}ã€‚ä½†ç›®å‰æ²¡æœ‰é…’åº—èƒ½â€œåŒæ—¶æ»¡è¶³â€è¿™äº›æ¡ä»¶ã€‚\næˆ‘å…ˆç»™ä½ æœ€æ¥è¿‘çš„ï¼š${briefList(near)}ã€‚\nä½ æ›´æ„¿æ„æ”¾æ¾å“ªä¸€é¡¹ï¼Ÿï¼ˆé¢„ç®— / åœ°é“è·ç¦» / å®‰é™ï¼‰`
            : `I applied: ${used}. There isnâ€™t a perfect match.\nClosest options are: ${briefList(near)}.\nWhich would you relax (budget / metro distance / quiet)?`));
          state.lastQuestion = 'relax';
          return;
        }

        cand = cand.slice().sort((a,b)=>{
          const pa = state.prevShortlistIds.includes(a.id) ? 1 : 0;
          const pb = state.prevShortlistIds.includes(b.id) ? 1 : 0;
          if(pa!==pb) return pb-pa;
          return scoreHotel(b)-scoreHotel(a);
        });
        const short = cand.slice(0, Math.min(pickN, cand.length));
        state.prevShortlistIds = short.map(h=>h.id);
        updateShortlist(short);

        // concise message: names only
        // (debug removed):
        // Determine next best question (one only) without loops
        let nextQ = null;
        if(!state.budgetMax && (intent.price || state.priority==='price')){
          nextQ = (lang2==='zh' ? 'ä½ æœ‰é¢„ç®—ä¸Šé™å—ï¼Ÿï¼ˆä¾‹å¦‚ï¼š600ä»¥å†…/800ä»¥å†…ï¼‰' : 'Do you have a budget ceiling? (e.g., under 600 / 800)');
          state.lastQuestion = 'budget';
        }else if(!state.metroMax && (state.priority==='location' || intent.location)){
          nextQ = (lang2==='zh' ? 'ä½ å¸Œæœ›ç¦»åœ°é“å‡ åˆ†é’Ÿä»¥å†…ï¼Ÿï¼ˆç›´æ¥å›æ•°å­—ï¼š5/8/10ï¼‰' : 'How many minutes to the metro? (reply with a number: 5/8/10)');
          state.lastQuestion = 'metro';
        }else if(!state.priority){
          nextQ = (lang2==='zh' ? 'æ¥ä¸‹æ¥ä½ æƒ³æŠŠå“ªä¸€é¡¹ä½œä¸ºç¬¬ä¸€ä¼˜å…ˆï¼šä»·æ ¼ / ä½ç½® / èˆ’é€‚ / å¯æŒç»­ï¼Ÿ' : 'What should be your #1 priority: price / location / comfort / sustainability?');
          state.lastQuestion = 'priority';
        }else{
          state.lastQuestion = null;
        }

        // Build response aligned with empowerment & non-manipulation
        const baseMsg = (lang2==='zh'
          ? `å·²åº”ç”¨ï¼š${used}ã€‚\nç›®å‰ç¬¦åˆä½ æ¡ä»¶çš„æœ‰ ${cand.length} å®¶ï¼Œä¼˜å…ˆå»ºè®®å…ˆçœ‹ï¼š${briefList(short)}ã€‚\néœ€è¦æˆ‘å¸®ä½ å¯¹æ¯”å…¶ä¸­ä¸¤å®¶å—ï¼Ÿï¼ˆä¾‹å¦‚ï¼šå¯¹æ¯”${short[0].id}å’Œ${short[Math.min(1,short.length-1)].id}ï¼‰ä½ å¯ä»¥ï¼šâ‘ ç‚¹å·¦ä¾§â€œAIæ¨èæ¸…å•â€æŸ¥çœ‹è¯¦æƒ…/ç›´æ¥é€‰æ‹©ï¼›â‘¡æŠŠä¸¤å®¶åŠ å…¥å¯¹æ¯”åç‚¹â€œå¯¹æ¯”â€ï¼›â‘¢ç»§ç»­å‘Šè¯‰æˆ‘æ›´å¤šåå¥½ï¼ˆæ¯”å¦‚æ›´å®‰é™/æ›´èˆ’é€‚/æ›´è¿‘åœ°é“/æƒ³è¦å¯æŒç»­ï¼‰ï¼Œæˆ‘ä¼šå†ç¼©å°èŒƒå›´ã€‚æœ€ç»ˆé€‰æ‹©ç”±ä½ å†³å®šã€‚`
          : `Applied: ${used}.\nThere are ${cand.length} matches. Iâ€™d prioritize: ${briefList(short)}.\nWant me to compare two of them? (e.g., compare ${short[0].id} and ${short[Math.min(1,short.length-1)].id}) You can: (1) use the AI shortlist to view details or select; (2) add two hotels to compare and press â€œCompareâ€; (3) tell me more preferences (quiet/comfort/metro/sustainability) and Iâ€™ll narrow it further. The final choice is yours.`
        );

        const nudge = (state.turn%2===0)
          ? (lang2==='zh' ? `\n\nğŸ” å°ç»“ï¼šç›®å‰æˆ‘ç†è§£çš„æ˜¯ã€Œ${constraintSummary()}ã€ã€‚å¦‚æœæœ‰ä»»ä½•ä¸å‡†ç¡®ï¼Œä½ å¯ä»¥éšæ—¶è¯´â€œä¿®æ”¹é¢„ç®—/ä¿®æ”¹ä½ç½®/ä¸è¦æ±‚å®‰é™/æ›´é‡è§†ç¯ä¿â€ç­‰ï¼Œæˆ‘ä¼šé©¬ä¸Šè°ƒæ•´ã€‚` : `\n\nğŸ” Quick check: I understood â€œ${constraintSummary()}â€. If anything is off, you can say â€œchange budget / change location / not strict about quiet / care more about sustainabilityâ€, and Iâ€™ll adjust right away.`)
          : '';

        if(intent.recommend || intent.unsure){
          const rec = (lang2==='zh'
            ? `\nï¼ˆæˆ‘ä¸ä¼šæ›¿ä½ ä¸‹å†³å®šï¼Œåªæ˜¯æŠŠä¿¡æ¯æ›´æ¸…æ™°åœ°ç»„ç»‡å‡ºæ¥ã€‚ï¼‰`
            : `\n(I wonâ€™t decide for you â€” Iâ€™m just organizing information so itâ€™s easier to choose.)`);
          ai(baseMsg + rec + nudge + (nextQ ? `\n\n${nextQ}` : ''));
          return;
        }

        // If user supplied a new constraint (budget/metro/quiet) acknowledge without re-asking same thing
        // Avoid asking metro if already set etc.
        ai(baseMsg + nudge + (nextQ ? `\n\n${nextQ}` : ''));
      }
// NOTE: keep send handlers below (do not remove)
      
      send.onclick = ()=>{ respond(inp.value); inp.value=''; inp.focus(); };
      inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ send.click(); }});
    }
  }

  function renderHotels(){
    const lang = logger.lang;
    const list = document.getElementById('hotelList');
    list.innerHTML = '';
    const data = (condition==='c3') ? filtered : hotels;

    data.forEach(h=>{
      const el = document.createElement('div');
      el.className = 'hotel';
      const ttl = hotelTitle(h, lang);
      const dist = district(h, lang);
      const hi = highlights(h, lang);
      const sust = h.sustainable ? sustLabel(h, lang) : '';
      const sustBadge = h.sustainable ? `<span class="badge green">ğŸŒ¿ ${sust}</span>` : '';
      const selected = (selectedHotelId===h.id);

      el.innerHTML = `
        <div>
          <h3>${h.id}. ${ttl}</h3>
          <div class="kpis">
            <div class="kpi">â˜… ${h.rating.toFixed(1)} (${h.reviews})</div>
            <div class="kpi">ğŸš‡ ${h.metro_min} min</div>
            <div class="kpi">ğŸ“ ${dist}</div>
          </div>
          <div class="badges">
            <span class="badge gray">${hi[0]}</span>
            <span class="badge gray">${hi[1]}</span>
            <span class="badge gray">${hi[2]}</span>
            ${sustBadge}
          </div>
          <div class="tiny" style="margin-top:8px">${cancelText(h, lang)}</div>
        </div>
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px">
          <div class="price">${fmtPrice(h.price)}</div>
          <div class="row" style="justify-content:flex-end">
            <button class="btn secondary" data-act="view" data-id="${h.id}">${t(lang,'view')}</button>
            <button class="btn" data-act="select" data-id="${h.id}">${selected ? t(lang,'selected') : t(lang,'select')}</button>
          </div>
          <label class="tiny"><input type="checkbox" data-act="cmp" data-id="${h.id}"/> ${t(lang,'compare')}</label>
        </div>
      `;
      list.appendChild(el);
    });

    list.querySelectorAll('button[data-act="view"]').forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute('data-id');
        const h = hotels.find(x=>x.id===id);
        logger.push('view_details', {hotelId:id});
        const sustSection = `
          <div class="hr"></div>
          <div style="font-weight:800; margin-bottom:6px">${t(logger.lang,'sustainability')}</div>
          <div class="small">${(condition==='c3') ? t(logger.lang,'sustainabilityText') : sustBlurb(h, logger.lang)}</div>
        `;
        openModal(
          `${h.id}. ${hotelTitle(h, logger.lang)}`,
          `â˜… ${h.rating.toFixed(1)} Â· ${fmtPrice(h.price)} Â· ğŸš‡ ${h.metro_min} min`,
          `<div class="small"><b>${logger.lang==='zh'?'äº®ç‚¹':'Highlights'}</b>: ${highlights(h, logger.lang).join(' Â· ')}</div>
           <div class="small" style="margin-top:8px"><b>${logger.lang==='zh'?'å–æ¶ˆæ”¿ç­–':'Cancellation'}</b>: ${cancelText(h, logger.lang)}</div>
           ${sustSection}`
        );
      };
    });

    list.querySelectorAll('button[data-act="select"]').forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute('data-id');
        selectedHotelId = id;
        logger.push('select_hotel', {hotelId:id});
        document.getElementById('btnContinue').disabled = false;
        renderHotels();
      };
    });

    list.querySelectorAll('input[data-act="cmp"]').forEach(cb=>{
      cb.onchange = ()=>{
        const id = cb.getAttribute('data-id');
        if(cb.checked) compareIds.add(id); else compareIds.delete(id);
        logger.push('compare_toggle', {hotelId:id, checked:cb.checked, size: compareIds.size});
        document.getElementById('btnCompare').disabled = (compareIds.size<2);
              const bsl2 = document.getElementById('btnCompareSL'); if(bsl2) bsl2.disabled = (compareIds.size<2);
      };
    });
  }

  function compareModal(){
    const lang = logger.lang;
    const ids = Array.from(compareIds).slice(0,4);
    const hs = ids.map(id=>hotels.find(h=>h.id===id)).filter(Boolean);
    const rows = hs.map(h=>`
      <tr>
        <td><b>${h.id}. ${hotelTitle(h, lang)}</b><div class="tiny">â˜… ${h.rating.toFixed(1)} Â· ğŸš‡ ${h.metro_min} min</div></td>
        <td>${fmtPrice(h.price)}</td>
        <td>${h.sustainable ? 'ğŸŒ¿' : 'â€”'}</td>
        <td class="tiny">${(condition==='c3') ? t(lang,'sustainabilityText') : sustBlurb(h, lang)}</td>
      </tr>`).join('');
    logger.push('open_compare', {ids});
    openModal(
      lang==='zh'?'å¯¹æ¯”':'Compare',
      ids.join(', '),
      `<table style="width:100%; border-collapse:collapse">
        <thead><tr>
          <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border)">${lang==='zh'?'é…’åº—':'Hotel'}</th>
          <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border)">${lang==='zh'?'ä»·æ ¼':'Price'}</th>
          <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border)">${lang==='zh'?'å¯æŒç»­':'Sust.'}</th>
          <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border)">${lang==='zh'?'è¯´æ˜':'Note'}</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>`
    );
  }

  document.getElementById('btnCompare').onclick = compareModal;
  document.getElementById('btnContinue').onclick = ()=>{
    if(!selectedHotelId) return;
    logger.finish({selectedHotelId});
  };

  function initLangSelector(){
    const sel = document.getElementById('langSel');
    sel.innerHTML = `
      <option value="en">${t('en','en')}</option>
      <option value="zh">${t('zh','zh')}</option>`;
    sel.value = logger.lang;
    sel.onchange = ()=>{
      const u = new URL(window.location.href);
      u.searchParams.set('lang', sel.value);
      window.location.href = u.toString();
    };
  }

  async function init(){
    initLangSelector();
    hotels = await loadHotels();
    filtered = hotels.slice();
    logger.push('page_load', {});
    renderStatic();
    renderLeftPanel();
    renderHotels();
    if(condition==='c3'){
      // trigger initial filter log
      logger.push('filter_change', {mustS:false, maxP:900, minR:0, maxM:999, count: filtered.length});
    }
  }

  init();
})();
</script>
</body>
</html>
